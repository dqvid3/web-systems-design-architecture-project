<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <title>Reportistica</title>
    <script src="reportistica/script.js"></script>
    <link href="imgs/favicon.ico" id="favicon" rel="icon" type="image/x-icon"/>
    <link href="reportistica/style.css" rel="stylesheet"/>
</head>
<body>
<div sec:authorize="isAuthenticated()">
    Welcome <b><span sec:authentication="name">Username</span></b>
    &nbsp;
    <i><span sec:authentication="principal.authorities">Roles</span></i>
</div>
<form th:action="@{/logout}" method="post">
    <input type="submit" value="Logout"/>
</form>
<h1>Genera Report</h1>
<form th:action="@{/reportistica}" method="post" id="generaReport">
    <label for="dateRange">Intervallo di Date:</label>
    <select id="dateRange" name="dateRange" th:value="Oggi" onchange="setDateRange(this.value)">
        <option value="Oggi" th:selected="${dateRange == 'Oggi'}">Oggi</option>
        <option value="Ieri" th:selected="${dateRange == 'Ieri'}">Ieri</option>
        <option value="Ultima settimana" th:selected="${dateRange == 'Ultima settimana'}">Ultima settimana</option>
        <option value="Ultimo mese" th:selected="${dateRange == 'Ultimo mese'}">Ultimo mese</option>
        <option value="Ultimo anno" th:selected="${dateRange == 'Ultimo anno'}">Ultimo anno</option>
        <option value="custom" th:selected="${dateRange == 'custom'}">Intervallo personalizzato</option>
    </select>

    <div id="customDates" th:class="${dateRange == 'custom' ? '' : 'hidden'}">
        <label for="startDate">Data Inizio:</label>
        <input type="datetime-local" id="startDate" name="startDate" th:value="${startDate}" required>

        <label for="endDate">Data Fine:</label>
        <input type="datetime-local" id="endDate" name="endDate" th:value="${endDate}" required>
    </div>

    <label for="cartelloneName">Nome Cartellone:</label>
    <select id="cartelloneName" name="cartelloneName" required>
        <option value="%">Tutti i Cartelloni</option>
        <option th:each="cartellone : ${cartelloni}"
                th:value="${cartellone.nome}"
                th:text="${cartellone.nome}"
                th:selected="${cartellone.nome == cartelloneName}">
        </option>
    </select>

    <label for="operator">Operatore:</label>
    <select id="operator" name="operator" th:value="COUNT" required>
        <option value="COUNT" th:selected="${operator == 'LIST'}">Lista</option>
        <option value="COUNT" th:selected="${operator == 'COUNT'}">Conteggio</option>
        <option value="AVG" th:selected="${operator == 'AVG'}">Media</option>
        <option value="SUM" th:selected="${operator == 'SUM'}">Somma</option>
        <option value="MAX" th:selected="${operator == 'MAX'}">Massimo</option>
        <option value="MIN" th:selected="${operator == 'MIN'}">Minimo</option>
    </select>

    <label for="sortOrder">Ordine:</label>
    <select id="sortOrder" name="sortOrder" th:value="ASC">
        <option value="ASC" th:selected="${sortOrder == 'ASC'}">Ascendente</option>
        <option value="DESC" th:selected="${sortOrder == 'DESC'}">Discendente</option>
    </select>

    <label for="minViews">Visualizzazioni Minime:</label>
    <input type="number" id="minViews" name="minViews" min="0" th:value="${minViews != null ? minViews : 0}" required>

    <label for="limit">Numero di Risultati:</label>
    <input type="number" id="limit" name="limit" min="1" th:value="${limit != null ? limit : 1000}" required>

    <button type="submit">Genera Report</button>
    <button type="button" onclick="setDefaultParams()">Reset</button>
</form>

<h2>Risultati</h2>
<div th:if="${results != null}">
    <h3 th:text="${dateRange == 'custom' ?  (startDate + ' - ' + endDate) : dateRange}"/>

    <table>
        <thead>
        <tr>
            <th>Ref Cartellone</th>
            <th>Nome</th>
            <th th:if="${operator == 'LIST'}">bo Visualizzazioni</th>
            <th th:if="${operator == 'COUNT'}">Numero Visualizzazioni</th>
            <th th:if="${operator == 'AVG'}">Durata Media Visualizzazioni</th>
            <th th:if="${operator == 'SUM'}">Durata Totale Visualizzazioni</th>
            <th th:if="${operator == 'MAX'}">Durata Massima Visualizzazione</th>
            <th th:if="${operator == 'MIN'}">Durata Minima Visualizzazione</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="report : ${results}">
            <td th:text="${report.refCartellone}">Ref Cartellone</td>
            <td th:text="${report.nome}">Nome</td>
            <td th:text="${report.risultato}">Risultato</td>
        </tr>
        </tbody>
    </table>
</div>

<h2>Esporta</h2>
<form th:action="@{/reportistica/esporta}" method="get">
    <label for="formato">Formato: </label>
    <select id="formato" name="formato" onchange="updateIcon()">
        <option value="pdf">PDF</option>
        <option value="xlsx">Excel</option>
    </select>
    <button type="submit">Esporta
        <img id="icon" src="imgs/reportistica/icon_pdf.svg" alt="Excel" style="width: 16px; height: 16px; vertical-align: middle;"/>
    </button>
</form>
</body>
</html>
